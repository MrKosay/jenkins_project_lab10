pipeline {
  agent any

  environment {
    VENV = '.venv'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Create venv') {
      steps {
        bat """
          if not exist %VENV% ( python -m venv %VENV% )
        """
      }
    }

    stage('Install dependencies') {
      steps {
        bat """
          call %VENV%\\Scripts\\activate
          python -m pip install --upgrade pip
          if exist requirements.txt pip install -r requirements.txt
        """
      }
    }

    stage('Lint') {
      steps {
        bat """
          call %VENV%\\Scripts\\activate
          flake8 .
        """
      }
    }

    stage('Tests (optional)') {
      when { expression { return fileExists('test') } }
      steps {
        bat """
          call %VENV%\\Scripts\\activate
          python -m unittest discover -s test -p "*test*.py"
        """
      }
    }
  }
}
